---
import { getCollection } from "astro:content";

const posts = (await getCollection("posts"))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);

function fmt(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clinical Monster Blog</title>
    <style>
      :root{
        --brand:#C8102E;      /* Kings red */
        --text:#0b0f19;       /* near-black */
        --muted:#556070;
        --border:#e7e7ea;
        --bg:#ffffff;
        --soft:#f6f7f9;
        --max:980px;
        --radius:14px;
      }

      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color:var(--text);
        line-height:1.6;
        background: var(--bg);
      }

      a{ color:var(--text); text-decoration:none; }
      a:hover{ text-decoration:underline; }

      .container{
        width:min(var(--max), calc(100% - 48px));
        margin:0 auto;
      }

      header{
        padding:20px 0 10px;
      }

      nav{
        display:flex;
        gap:16px;
        margin-top:10px;
      }
      nav a{ color:var(--muted); }
      nav a:hover{ color:var(--text); }

      /* Hero */
      .heroWrap{
        margin-top: 14px;
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) + 6px);
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        overflow:hidden;
      }
      .hero{
        padding: 26px 26px 22px;
        display:grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .brandRow{
        display:flex;
        align-items:center;
        gap: 14px;
      }
      .logo{
        width: 120px;
        height:auto;
        border-radius: 10px;
        border: 1px solid var(--border);
        background:#fff;
        padding: 8px 10px;
      }

      .title{
        font-size: 40px;
        line-height: 1.08;
        letter-spacing: -0.03em;
        margin: 2px 0 0;
      }
      .subtitle{
        color: var(--muted);
        margin: 0;
        max-width: 75ch;
        font-size: 16px;
      }

      .ctaRow{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .btn{
        display:inline-flex;
        align-items:center;
        gap:10px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        font-weight: 600;
      }
      .btnPrimary{
        background: var(--brand);
        color: #fff;
        border-color: rgba(0,0,0,.08);
      }
      .btnPrimary:hover{ text-decoration:none; filter: brightness(.98); }
      .btn:hover{ text-decoration:none; border-color: #cfd3da; }

      .pillRow{
        display:flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .pill{
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        background: var(--soft);
        padding: 6px 10px;
        border-radius: 999px;
      }

      /* Sections */
      .section{
        margin-top: 26px;
        padding-bottom: 28px;
      }
      .sectionWrap{
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) + 6px);
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 20px;
      }
      .sectionHeader{
        display:flex;
        align-items:baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      .sectionHeader h2{
        margin:0;
        font-size: 18px;
        letter-spacing: -0.01em;
      }
      .sectionHeader a{
        color: var(--muted);
        font-size: 14px;
      }

      .cards{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .card{
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 14px;
        background: rgba(255, 255, 255, 0.5);
        display:grid;
        grid-template-columns: 140px 1fr;
        gap: 14px;
        align-items:center;
      }
      @media (max-width: 720px){
        .card{ grid-template-columns: 1fr; }
        .logo{ width: 96px; }
        .title{ font-size: 34px; }
      }

      .thumb{
        width:100%;
        height:86px;
        border-radius: 12px;
        border: 1px solid var(--border);
        object-fit: cover;
        background: var(--soft);
      }

      .card h3{
        margin:0 0 6px;
        font-size: 16px;
        line-height: 1.25;
      }
      .card p{
        margin:0 0 6px;
        color: var(--muted);
        font-size: 14px;
      }
      .meta{
        color: var(--muted);
        font-size: 12px;
      }

      footer{
        border-top: 1px solid var(--border);
        padding: 18px 0 26px;
        color: var(--muted);
        font-size: 13px;
        background: var(--bg);
        position: relative;
        z-index: 10;
      }
      .brandDot{
        display:inline-block;
        width:10px;
        height:10px;
        border-radius:999px;
        background: var(--brand);
        margin-right: 8px;
        transform: translateY(1px);
      }

      /* Home Banner - scrollable background layer */
      .home-banner-layer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 100vh;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .home-banner {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: var(--bannerHeight, 600px);
        background-image: url("/images/banner-clinical-monsters.png");
        background-size: cover;
        background-position: center top;
        opacity: var(--bannerOpacity, 1);
        transform: translateY(var(--bannerScroll, 0px));
        transition: opacity 0.05s linear;
      }
      .home-banner::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.4) 80%, rgba(255,255,255,1) 100%);
        pointer-events: none;
      }

      /* Fixed foreground layer - hero + posts stay put */
      .fixed-foreground {
        position: relative;
        z-index: 10;
        pointer-events: auto;
      }

      header.container {
        position: relative;
        z-index: 1;
      }

      /* Main content needs proper z-index */
      main.container {
        position: relative;
        z-index: 10;
      }

      @media (max-width: 640px) {
        .home-banner {
          --bannerHeight: 400px;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        .home-banner {
          opacity: 1;
          transform: none;
          transition: none;
        }
      }
    </style>
  </head>

  <body>
    <!-- Fixed banner layer that scrolls at parallax speed -->
    <div class="home-banner-layer" aria-hidden="true">
      <div id="homeBanner" class="home-banner"></div>
    </div>

    <!-- Foreground content - stays in place while banner scrolls behind -->
    <div class="fixed-foreground">
      <header class="container">
        <div style="font-weight:650;">Clinical Monster Blog</div>
        <nav>
          <a href="/">Home</a>
          <a href="/blog">Blog</a>
          <a href="/admin/">Editor Login</a>
        </nav>

        <div class="heroWrap">
          <div class="hero">
            <div class="brandRow">
              <img class="logo" src="/images/kings-logo.png" alt="Kings County / Downstate Emergency Medicine" />
              <div>
                <div style="color: var(--muted); font-size:12px; letter-spacing:.12em; text-transform:uppercase;">
                  Emergency Medicine • FOAMed • Kings County / Downstate
                </div>
                <h1 class="title">Clinical Monster</h1>
              </div>
            </div>

            <p class="subtitle">
              High-yield, practical emergency medicine notes—built for busy clinicians.
              Weekly posts, clean visuals, and the occasional obsession with workflow.
            </p>

            <div class="ctaRow">
              <a class="btn btnPrimary" href="/blog">Read the Blog →</a>
            </div>

            <div class="pillRow">
              <span class="pill">Ultrasound</span>
              <span class="pill">Resus</span>
              <span class="pill">Evidence</span>
              <span class="pill">Workflow</span>
              <span class="pill">ECG</span>
              <span class="pill">Images / Photos</span>
            </div>
          </div>
        </div>
      </header>
    </div>

    <main class="container section">
      <div class="sectionWrap">
        <div class="sectionHeader">
          <h2>Latest Posts</h2>
          <a href="/blog">View all</a>
        </div>

        <div class="cards">
          {posts.map((post) => (
            <a class="card" href={`/blog/${post.slug}/`}>
              <img
                class="thumb"
                src={post.data.hero_image ?? "/images/uploads/placeholder.png"}
                alt={post.data.title}
                loading="lazy"
              />
              <div>
                <h3>{post.data.title}</h3>
                {post.data.excerpt ? <p>{post.data.excerpt}</p> : null}
                <div class="meta">
                  <span>{post.data.author ?? "Clinical Monster Blog"}</span>
                  <span style="opacity:.5;"> • </span>
                  <span>{fmt(post.data.date)}</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <span class="brandDot"></span>
        Built with Astro + Decap CMS • <a href="/blog">Blog</a> • <a href="/admin/">Admin</a>
      </div>
    </footer>

    <script>
      (function() {
        // Constants - tweak these to adjust behavior
        const FADE_START = 700;     // px of scroll before fade begins (extended to reach Latest Posts section)
        const FADE_DISTANCE = 800;  // px of scroll for banner to fade from 1 to 0 (slower transition)
        const PARALLAX_SPEED = 0.6; // Banner scrolls at 60% of page scroll speed (0 = fixed, 1 = normal)

        // Respect prefers-reduced-motion
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) return;

        const root = document.documentElement;
        let ticking = false;

        function updateBanner() {
          const scrollY = window.scrollY || window.pageYOffset;

          // Parallax: banner scrolls slower than the page
          const bannerScroll = scrollY * PARALLAX_SPEED;
          root.style.setProperty('--bannerScroll', `-${bannerScroll}px`);

          // Banner stays at full opacity until FADE_START, then fades over FADE_DISTANCE
          const fadeProgress = Math.max(0, scrollY - FADE_START) / FADE_DISTANCE;
          const opacity = Math.max(0, Math.min(1, 1 - fadeProgress));
          root.style.setProperty('--bannerOpacity', opacity.toString());

          ticking = false;
        }

        function onScroll() {
          if (!ticking) {
            requestAnimationFrame(updateBanner);
            ticking = true;
          }
        }

        // Initialize on load (handles mid-page reload)
        updateBanner();

        window.addEventListener('scroll', onScroll, { passive: true });
      })();
    </script>
  </body>
</html>
